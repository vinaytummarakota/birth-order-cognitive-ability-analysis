---
title: "01a_clean_data"
author: "Vinay Tummarakota"
date: "2025-11-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("./01_helper_functions.R")
```

```{r}
df <- read.csv("../00_raw_nlsy_data/birth_order_analysis_vars.csv")

new_cols <- c(
  "case_id", 
  "family_id",
  "birth_order", 
  "sample_id", 
  "race", 
  "sex", 
  "month_of_birth", 
  "year_of_birth", 
  "month_of_1981_interview",
  "sampling_weight", 
  "asvab_section_1_general_science",
  "asvab_section_2_arithmetic_reasoning",
  "asvab_section_3_word_knowledge",
  "asvab_section_4_paragraph_comprehension",
  "asvab_section_5_numerical_operations",
  "asvab_section_6_coding_speed",
  "asvab_section_7_auto_and_shop_info",
  "asvab_section_8_mathematics_knowledge",
  "asvab_section_9_mechanical_comp",
  "asvab_section_10_electronics_info",
  "age_at_interview"
)

# these columns automatically accompany the NLSY data but will not be used in this analysis
dropped_cols <- c(
  "race", 
  "sex"
)

cleaned_df <- clean_df(df, colnames(df), new_cols, dropped_cols)
write.csv(cleaned_df, "cleaned_nlsy79_data.csv", row.names = FALSE)
```

Tests: 
1. The number of rows did not change. 
2. The number of children in each sample aligns. 
3. The birth orders correspond to the ages of the siblings. 

EDA: 
- Table, mean and standard deviation of score by ASVAB subtest
- Table, mean scores by birth order and ASVAB subtest
- Histogram, distribution of ages by birth order
- Histogram, distribution of scores by birth order and ASVAB subtest
- Histogram, distribution of age differences between first, second, and third-born siblings
- Coefficient plot, within-family effect of birth order on subtests
- Heatmap, correlation matrix between all ASVAB subtests in total population
- Heatmap, correlation matrix between all ASVAB subtests by birth order

```{r}

long_df <- cleaned_df %>%
  pivot_longer(
    cols = starts_with("asvab"), 
    names_to = "asvab_subtest", 
    values_to = "score"
  ) %>%
  mutate(
    age_bucket = 0.33 * round(estimated_age / 0.33)
  ) %>%
  group_by(
    age_bucket, 
    asvab_subtest
  ) %>%
  summarise(
    avg_score = mean(score, na.rm = TRUE)
  )

ggplot(long_df, aes(x = age_bucket, y = avg_score))+
  geom_point()+
  facet_wrap(~asvab_subtest)+
  scale_y_continuous(limits = c(35, 70))
```
